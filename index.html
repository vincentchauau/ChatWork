<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-signin-client_id"
    content="s16442107851-bakth7o154hdfa05ngqdm8pdr1h0lnml.apps.googleusercontent.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css')}}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://apis.google.com/js/api:client.js"></script>
  <script src="{{ url_for('static', filename='function.js')}}"></script>
  <title>Làm gì đây</title>
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <meta name="google-signin-client_id"
    content="103178889954-jn7h5oipfmv7qmol1br5ju95lctqrolg.apps.googleusercontent.com">
</head>

<body>
  <header>
    <audio loop autoplay>
      <source src="https://aredir.nixcdn.com/Unv_Audio7/LoveTheWayYouLie-Eminem_3sbz4.mp3" type="audio/mpeg">
    </audio>
    <a href="tel:0914900914">0914 900 914</a><br>
    <a href="http://maps.google.com/?q=81 Nguyen Cuu Van, P.17, Q. Binh Thanh, TP. Ho Chi Minh">81/32 Nguyen Cuu Van St,
      Ward 17, Binh Thanh District</a><br>
    <a href="mailto:chatwork@gmail.com" target="_top">chatwork@gmail.com</a><br>
    <a href="https://github.com/vincentchauau" target="_top">https://github.com/vincentchauau</a><br>
    <a href="https://www.linkedin.com/in/vincentchauau" target="_top">https://www.linkedin.com/in/vincentchauau</a><br>
    <br>
  </header>
  <main>
    <!-- 
    Hide Mode Import fImport Export fExport Clear Get Row Column Insert Select Delete Set
    Header Row
    Input Row
    Output Rows
    First -100 -10 -1 Current +1 +10 +100 Last -->
    <div id="tbTable">
      <navbar>
        <div id='btLogin' style="background-size: 100% 100%;">___</div>
        <script>
          gapi.load('auth2', function(){
          auth2 = gapi.auth2.init({
            client_id: '103178889954-jn7h5oipfmv7qmol1br5ju95lctqrolg.apps.googleusercontent.com',
            cookiepolicy: 'single_host_origin',
          });
          attachSignin(document.getElementById('btLogin'));
        });

        function attachSignin(element) {
          auth2.attachClickHandler(element, {},
              function(googleUser) {
                profile = googleUser.getBasicProfile();
                alert(profile.getImageUrl())
                $("#btLogin").css("background-image", "url(" + profile.getImageUrl() + ")");
              }, function(error) {
                alert(JSON.stringify(error, undefined, 2));
              });
        }
        </script>
        <button>Hide</button>
        <button>Mod</button>
        <button>Imp</button>
        <input type='file' hidden />
        <button>Exp</button>
        <input type='file' hidden />
        <select></select>
        <button>Clr</button>
        <button>Get</button>
        <select></select>
        <select></select>
        <button>Ins</button>
        <button>Sel</button>
        <button>Del</button>
        <button>Set</button>
      </navbar>
      <navbar>
        <button>First</button>
        <button>-100</button>
        <button>-10</button>
        <button>-1</button>
        <button>Page</button>
        <button>+1</button>
        <button>+10</button>
        <button>+100</button>
        <button>Last</button>
      </navbar>
      <item style='border:1px solid'></item>
      <item style='border:1px solid'></item>
      <items></items>
    </div>
  </main>
  <footer>
    <a href="tel:0914900914">0914 900 914</a><br>
    <a href="http://maps.google.com/?q=81 Nguyen Cuu Van, P.17, Q. Binh Thanh, TP. Ho Chi Minh">81/32 Nguyen Cuu Van St,
      Ward 17, Binh Thanh District</a><br>
    <a href="mailto:chatwork@gmail.com" target="_top">chatwork@gmail.com</a><br>
    <a href="https://github.com/vincentchauau" target="_top">https://github.com/vincentchauau</a><br>
    <a href="https://www.linkedin.com/in/vincentchauau" target="_top">https://www.linkedin.com/in/vincentchauau</a><br>
  </footer>
</body>
<script>
  //////////////////////////////////// Controls
  // Variables
  var profile;
  var user = {};
  var colors = [ // colors[type:13][degree:9]
    ["#330000", "#660000", "#990000", "#cc0000", "#ff0000", "#ff3333", "#ff6666", "#ff9999", "#ffcccc"],
    ["#331900", "#663300", "#994c00", "#cc6600", "#ff8000", "#ff9933", "#ffb266", "#ffcc99", "#ffe5cc"],
    ["#333300", "#666600", "#999900", "#cccc00", "#ffff00", "#ffff33", "#ffff66", "#ffff99", "#ffffcc"],
    ["#193300", "#336600", "#4c9900", "#66cc00", "#80ff00", "#99ff33", "#b2ff66", "#ccff99", "#e5ffcc"],
    ["#003300", "#006600", "#009900", "#00cc00", "#00ff00", "#33ff33", "#66ff66", "#99ff99", "#ccffcc"],
    ["#003319", "#006633", "#00994c", "#00cc66", "#00ff80", "#33ff99", "#66ffb2", "#99ffcc", "#ccffe5"],
    ["#003333", "#006666", "#009999", "#00cccc", "#00ffff", "#33ffff", "#66ffff", "#99ffff", "#ccffff"],
    ["#001933", "#003366", "#004c99", "#0066cc", "#0080ff", "#3399ff", "#66b2ff", "#99ccff", "#cce5ff"],
    ["#000033", "#000066", "#000099", "#0000cc", "#0000ff", "#3333ff", "#6666ff", "#9999ff", "#ccccff"],
    ["#190033", "#330066", "#4c0099", "#6600cc", "#7f00ff", "#9933ff", "#b266ff", "#cc99ff", "#e5ccff"],
    ["#330033", "#660066", "#990099", "#cc00cc", "#ff00ff", "#ff33ff", "#ff66ff", "#ff99ff", "#ffccff"],
    ["#330019", "#660033", "#99004c", "#cc0066", "#ff007f", "#ff3399", "#ff66b2", "#ff99cc", "#ffcce5"],
    ["#000000", "#202020", "#404040", "#606060", "#808080", "#a0a0a0", "#c0c0c0", "#e0e0e0", "#ffffff"]];
  String.prototype.format = function () {
    formatted = this;
    for (var i = 0; i < arguments.length; ++i) {
      formatted = formatted.replace("{" + i + "}", arguments[i]);
    }
    return formatted;
  };

  String.prototype.visualLength = function (parentNode) {
    ruler = document.createElement('span');
    ruler.id = 'ruler';
    document.getElementsByTagName("main")[0].appendChild(ruler);
    if (parentNode) {
      for (var i = parentNode.style.length; i-- > 0;) {
        var name = parentNode.style[i];
        ruler.style.setProperty(name, parentNode.style.getPropertyValue(name), priority = parentNode.style.getPropertyPriority(name));
      }
    }
    else {
    }
    ruler.innerHTML = this;
    length = ruler.offsetWidth;
    ruler.remove();
    return length;
  }

  // jq node la tap hop dom node, xpath cua dom node la tap hop dom node
  $.fn.extend({
    xpath: function (path) {
      var nodes = document.evaluate(xpath($(this)[0]) + path, $(this)[0], null, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
      result = [];
      while (node = nodes.iterateNext()) {
        result.push(node);
      }
      $result = jQuery([]).pushStack(result);
      return $result;
    },
    split: function (direction, percent, mouseMove, mouseUp) {
      const first = $(this).children().eq(0);
      const separator = $(this).children().eq(1);
      const second = $(this).children().eq(2);
      separator.css("margin", "0px");
      separator.css("borderRadius", "5px");
      separator.css("backgroundSize", "100% 100%");
      var md;
      if (direction == "V") {
        $(this).css("display", "flex");
        first.css("width", percent + "%");
        second.css("width", (100 - percent) + "%");
        first.css("minWidth", "0px");
        second.css("minWidth", "0px");
        separator.css("width", "10px");
        separator.css("height", "100%");
        separator.css("cursor", "col-resize");
        separator.css("backgroundImage", "url('../vertical.png')");
        separator.on("mousedown", onMouseDown);
        function onMouseDown(e) {
          var md = { e, offsetLeft: separator.offset().left, offsetTop: separator.offset().top, firstWidth: first.outerWidth(), secondWidth: second.outerWidth() };
          if ((e.clientY - separator.offset().top) <= separator.outerHeight() / 2 && (e.clientY - separator.offset().top) >= separator.outerHeight() / 2 - 20) {
            first.css("width", (md.firstWidth + md.secondWidth) + "px");
            second.css("width", "0px");
            separator.css("left", "0px");
          }
          else if ((e.clientY - separator.offset().top) >= separator.outerHeight() / 2 && (e.clientY - separator.offset().top) <= separator.outerHeight() / 2 + 20) {
            first.css("width", "0px");
            second.css("width", (md.firstWidth + md.secondWidth) + "px");
            separator.css("left", "0px");
          }
          else {
            document.onmousemove = onMouseMove;
            document.onmouseup = function () {
              document.onmousemove = document.onmouseup = null;
              mouseUp();
            }
          }
        }
        function onMouseMove(e) {
          if ((e.clientY - separator.offset().top) >= separator.outerHeight() / 2 - 20 && (e.clientY - separator.offset().top) <= separator.outerHeight() / 2 + 20) {
          }
          else {
            var delta = { x: e.clientX - md.e.clientX, y: e.clientY - md.e.clientY };
            delta.y = Math.min(Math.max(delta.y, - md.firstHeight), md.secondHeight);
            first.css("width", (md.firstWidth + delta.x) + "px");
            second.css("width", (md.secondWidth - delta.x) + "px");
            separator.css("left", md.offset().left + delta.x + "px");
            mouseMove();
          }
        }
      }
      else {
        $(this).css("display", "flex");
        $(this).css("flexDirection", "column");
        first.css("height", percent + "%");
        second.css("height", (100 - percent) + "%");
        first.css("minHeight", "0px");
        second.css("minHeight", "0px");
        separator.css("width", "100%");
        separator.css("height", "10px");
        separator.css("cursor", "row-resize");
        separator.css("backgroundImage", "url('../horizontal.png')");
        separator.on("mousedown", onMouseDown);
        function onMouseDown(e) {
          md = { e, offsetLeft: separator.offset().left, offsetTop: separator.offset().top, firstHeight: first.outerHeight(), secondHeight: second.outerHeight() };
          if ((e.clientX - separator.offset().left) <= separator.outerWidth() / 2 && (e.clientX - separator.offset().left) >= separator.outerWidth() / 2 - 20) {
            first.css("height", (md.firstHeight + md.secondHeight) + "px");
            second.css("height", "0px");
            separator.css("top", "0px");
          }
          else if ((e.clientX - separator.offset().left) >= separator.outerWidth() / 2 && (e.clientX - separator.offset().left) <= separator.outerWidth() / 2 + 20) {
            first.css("height", "0px");
            second.css("height", (md.firstHeight + md.secondHeight) + "px");
            separator.css("top", "0px");
          }
          else {
            md = { e, offsetLeft: separator.offset().left, offsetTop: separator.offset().top, firstHeight: first.outerHeight(), secondHeight: second.outerHeight() };
            document.onmousemove = onMouseMove;
            document.onmouseup = () => {
              document.onmousemove = document.onmouseup = null;
              mouseUp();
            }
          }
        }
        function onMouseMove(e) {
          if ((e.clientX - separator.offset().left) >= separator.outerWidth() / 2 - 20 && (e.clientX - separator.offset().left) <= separator.outerWidth() / 2 + 20) {
          }
          else {
            var delta = { x: e.clientX - md.e.clientX, y: e.clientY - md.e.clientY };
            delta.y = Math.min(Math.max(delta.y, - md.firstHeight), md.secondHeight);
            first.css("height", (md.firstHeight + delta.y) + "px");
            second.css("height", (md.secondHeight - delta.y) + "px");
            separator.css("top", md.offset().top + delta.y + "px");
            mouseMove();
          }
        }
      }
    }
  })
  function xpath(element) {
    var xpath = "";
    for (; element && element.nodeType == 1; element = element.parentNode) {
      var id = $(element.parentNode).children(element.tagName).index(element) + 1;
      // id > 1 ? (id = '[' + id + ']') : (id = '');
      id = '[' + id + ']';
      xpath = "/" + element.tagName.toLowerCase() + id + xpath;
    }
    return xpath;
  }

  ///////////////////////////////////////////// SQL
  // Get rows
  function getSQL(table, columns, values) {
    result = "SELECT * FROM {0}".format(table);
    where = "";
    for (var i = 0; i < values.length; ++i) {
      if (values[i] != "")
        where += " {0} LIKE '%{1}%' AND".format(columns[i], values[i]);
    }
    if (where != "") {
      where = where.slice(0, where.length - 4);
      return result + " WHERE " + where;
    }
    else return result;
  }

  // Insert rows
  function insertSQL(table, columns, values) {
    column = "";
    value = "";
    for (var i = 1; i < values.length; ++i) {
      column += columns[i] + ",";
      value += "'{0}',".format(values[i]);
    }
    column = column.slice(0, column.length - 1);
    value = value.slice(0, value.length - 1);
    return "INSERT INTO {0}({1}) VALUES ({2})".format(table, column, value);
  }

  // Delete rows
  function deleteSQL(table, columns) {
    return "DELETE FROM {0} WHERE {1}=".format(table, columns[0]);
  }

  // Set rows
  function setSQL(table, columns, values) {
    column = "";
    value = "";
    for (var i = 1; i < values.length; ++i) {
      value += "{0}='{1}',".format(columns[i], values[i]);
    }
    value = value.slice(0, value.length - 1);
    return "UPDATE {0} SET {1} WHERE {2}=".format(table, value, columns[0]);
  }

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////
  // MAIN
  $(document).ready(function () {
    btHide = $("#tbTable").xpath("/navbar[1]/button[1]");
    btMode = $("#tbTable").xpath("/navbar[1]/button[2]");
    btImport = $("#tbTable").xpath("/navbar[1]/button[3]");
    fImport = $("#tbTable").xpath("/navbar[1]/input[1]");
    btExport = $("#tbTable").xpath("/navbar[1]/button[4]");
    fExport = $("#tbTable").xpath("/navbar[1]/input[2]");
    cbGet = $("#tbTable").xpath("/navbar[1]/select[1]");
    btClear = $("#tbTable").xpath("/navbar[1]/button[5]");
    btGet = $("#tbTable").xpath("/navbar[1]/button[6]");
    cbRow = $("#tbTable").xpath("/navbar[1]/select[2]");
    cbColumn = $("#tbTable").xpath("/navbar[1]/select[3]");
    btInsert = $("#tbTable").xpath("/navbar[1]/button[7]");
    btSelect = $("#tbTable").xpath("/navbar[1]/button[8]");
    btDelete = $("#tbTable").xpath("/navbar[1]/button[9]");
    btSet = $("#tbTable").xpath("/navbar[1]/button[10]");

    btPageFirst = $("#tbTable").xpath("/navbar[2]/button[1]");
    btPageBack100 = $("#tbTable").xpath("/navbar[2]/button[2]");
    btPageBack10 = $("#tbTable").xpath("/navbar[2]/button[3]");
    btPageBack1 = $("#tbTable").xpath("/navbar[2]/button[4]");
    btPage = $("#tbTable").xpath("/navbar[2]/button[5]");
    btPageNext1 = $("#tbTable").xpath("/navbar[2]/button[6]");
    btPageNext10 = $("#tbTable").xpath("/navbar[2]/button[7]");
    btPageNext100 = $("#tbTable").xpath("/navbar[2]/button[8]");
    btPageLast = $("#tbTable").xpath("/navbar[2]/button[9]");
    itHeader = $("#tbTable").xpath("/item[1]");
    itInput = $("#tbTable").xpath("/item[2]");
    itOutput = $("#tbTable").xpath("/items");

    // Variables
    tables = [];
    table = "";
    columns = [];
    types = null;
    rows = [];
    values = [];
    cbRow.html("<option>5</option><option>10</option><option>20</option><option>25</option>");
    cbColumn.html("<option>1</option><option>2</option><option>4</option><option>8</option><option>12</option><option>16</option>");
    row = 5;
    col = 1;
    pageIndex = 0;
    selectAllRows = false;
    hideState = false;
    editState = false;
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Login
    if (profile == null)
    {
      $("#btLogin").css("background-image", "url(user.png)");
    }
    else
    {
      $("#btLogin").css("background-image", "url(" + profile.getImageUrl() + ")");
    }
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Hide/show view
    btHide.on("mousedown", function () {
      $("header").toggle();
      $("footer").toggle();
      itHeader.xpath("/cell[position() > 3]").toggle();
      itInput.xpath("/cell[position() > 3]").toggle();
      itOutput.xpath("/item/cell[position() > 3]").toggle();
      hideState = !hideState;
      if (hideState) {
        btHide.text("Show");
      }
      else {
        btHide.text("Hide");
      }
      // hide & edit => view
      if (hideState == true && editState == true) {
        editState = !editState;
        itOutput.xpath("/item/cell[position() > 1]").each(function (index) {
          $(this).xpath("/edit").toggle();
          $(this).xpath("/view").toggle();
        })
      }
      else // show mode
      { }
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Color & wrap
    btMode.on("mousedown", function () {
      // Color randomly
      i = Math.floor(Math.random() * 13);
      dark = Math.random() < 0.5;
      if (dark == true) {
        backgroundColor = "linear-gradient(to left top, {0}, {1}, {2})".format(hex2rgb(colors[i][0]).replace(')', ', 0.2)').replace('rgb', 'rgba'), hex2rgb(colors[i][0]).replace(')', ', 0.8)').replace('rgb', 'rgba'), hex2rgb(colors[i][0]).replace(')', ', 0.2)').replace('rgb', 'rgba'));
        //backgroundColor = colors[i][0];
        borderColor = colors[i][1];
        textColor = colors[i][8];
      }
      else {
        backgroundColor = "linear-gradient(to left top, {0}, {1}, {2})".format(hex2rgb(colors[i][8]).replace(')', ', 0.8)').replace('rgb', 'rgba'), hex2rgb(colors[i][8]).replace(')', ', 0.2)').replace('rgb', 'rgba'), hex2rgb(colors[i][8]).replace(')', ', 0.8)').replace('rgb', 'rgba'));
        // backgroundColor = colors[i][8];
        borderColor = colors[i][7];
        textColor = colors[i][0];
      }
      addCSS("*", "background: {0}; color: {1}; border-color: {2}".format(backgroundColor, textColor, borderColor));
      addCSS(".special > *", "background-color: {0}; color: {1}".format(backgroundColor, textColor));
      addCSS("button:hover", "background-color: {0}; color: {1}".format(textColor, backgroundColor));
      addCSS("::selection", "background-color: {0}; color: {1}".format(textColor, backgroundColor));
      addCSS(".selected", "background-color: {0}; color: {1}".format(textColor, backgroundColor));
      addCSS(".selected *", "background-color: {0}; color: {1}".format(textColor, backgroundColor));

    })

    btMode.trigger("mousedown");
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Import data from an excel file
    btImport.on("mousedown", function () {
      fImport.click();
      var form_data = new FormData($('#upload-file')[0]);
      $.ajax({
        type: 'POST',
        url: '/upload',
        data: form_data,
        contentType: false,
        cache: false,
        processData: false,
        success: function (data) {
          console.log('Success!');
        },
      });
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Export data
    btExport.on("mousedown", function () {
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Delete input row
    btClear.on("mousedown", function () {
      itInput.xpath("/data").children().each(function () {
        $(this).text("");
      })
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Get tables
    $.ajax({
      type: "POST", url: "/", data: { command: "tables" }, dataType: "json", success: function (result) {
        tables = result;
        html = "";
        for (i = 0; i < tables.length; ++i) {
          html += "<option>{0}</option>".format(result[i]);
        }
        cbGet.html(html);
        table = cbGet.val();
        $.ajax({
          type: "POST", url: "/", data: { command: "columns", table: table }, dataType: "json", success: function (result) {
            columns = result;
            html1 = "", html2 = "";
            // Get header & input rows
            for (i = 0; i < columns.length; ++i) 
            {
              html1 += "<cell style='min-width:100px; justify-content:center'><view><b>{0}</b></view></cell>".format(columns[i]);
              html2 += "<cell style='min-width:100px'><edit style='display:block' contenteditable spellcheck='false'></edit></cell>";
            }
            itHeader.html(html1);
            itInput.html(html2);

            // Get output rows
            btClear.trigger("mousedown");
            btGet.trigger("mousedown");
          }
        })
      }
    })

    // Get columns & all rows
    cbGet.on("change", function () {
      table = $(this).val();
      $.ajax({
        type: "POST", url: "/", data: { command: "columns", table: table }, dataType: "json", success: function (result) {
          columns = result;
          html1 = "", html2 = "";
          // Get header & input rows
          for (i = 0; i < columns.length; ++i) {
            html1 += "<cell style='min-width:100px; justify-content:center'><view><b>{0}</b></view></cell>".format(columns[i]);
            html2 += "<cell style='min-width:100px'><edit style='display:block' contenteditable spellcheck='false'></edit></cell>";
          }
          itHeader.html(html1);
          itInput.html(html2);

          // Get output rows
          btClear.trigger("mousedown");
          btGet.trigger("mousedown");
        }
      })
    })


    // Get input row
    function getInput(item) {
      result = [];
      item.xpath("/edit").each(function (index) {
        result[index] = $(this).text();
      })
      return result;
    }

    // Get rows
    function getPage(page) {
      // Get real page index
      if (page > Math.ceil(rows.length / (row * col))) {
        pageIndex = 1;
      }
      else if (page < 1) {
        pageIndex = Math.ceil(rows.length / (row * col));
      }
      else {
        pageIndex = page;
      }
      btPage.text("Page " + pageIndex);
      startIndex = (pageIndex - 1) * row * col;
      endIndex = pageIndex * row * col > rows.length ? rows.length : pageIndex * row * col;

      // Get column widths
      if (columns.length != null && rows.length != null) {
        itOutput.css("gridTemplateRows", "1fr ".repeat(row));
        itOutput.css("gridTemplateColumns", "1fr ".repeat(col));
        max = Array(columns.length).fill(0);
        avg = Array(columns.length).fill(0);
        size = 0;
        for (i = 0; i < columns.length; ++i) {
          for (j = startIndex; j < endIndex; ++j) {
            if (max[i] < rows[j][i].length) {
              max[i] = rows[j][i].visualLength();
            }
            else { }
            avg[i] += rows[j][i].visualLength();
          }
          if (columns[i].startsWith("IMG")) {
            avg[i] = 100;
          }
          else if (max[i] - 15 < avg[i]) {
            avg[i] = max[i] + 30;
          }
          else {
            avg[i] = avg[i] + 15;
          }
        }
      }

      full = false;
      // Get rows
      html = "";
      for (i = startIndex; i < endIndex; ++i) {
        html += "<item>";
        for (j = 0; j < columns.length; ++j) {
          if (columns[j].startsWith("ID")) 
          {
            if (full == true)
            { 
              html += "<cell style='flex-grow: 0; flex-basis: {0}px'><edit contenteditable spellcheck='false'>{1}</edit><view>{2}</view></cell>".format(avg[j], rows[i][j], rows[i][j]);
            }
            else
            {
              html += "<cell style='flex-grow: 0; flex-basis: {0}px'><edit contenteditable spellcheck='false'>{1}</edit><view></view></cell><break></break>".format(avg[j], rows[i][j]);
            }
          }
          else if (columns[j].startsWith("IMG")) {
            images = rows[i][j].split(";");
            imageHtml = "";
            for (k = 0; k < images.length; ++k) {
              imageHtml += "<img src='/images/{0}'>".format(images[k]);
            }
            if (full == true)
            {
              html += "<cell style='flex-grow: 0; flex-basis: {0}px'><edit contenteditable spellcheck='false'>{1}</edit><view>{2}</view></cell>".format(avg[j], rows[i][j], imageHtml);
            }
            else
            {
              html += "<cell style='flex-grow: 0; flex-basis: {0}px'><edit contenteditable spellcheck='false'>{1}</edit><view>{2}</view></cell><break></break>".format(avg[j], rows[i][j], imageHtml);
            }
          }
          else if (columns[j].startsWith("N_")) {
            html += "<cell style='flex-basis: {0}px; justify-content:right'><edit contenteditable spellcheck='false'>{1}</edit><view>{2}</view></cell>".format(avg[j], rows[i][j], rows[i][j]);
          }
          else {
            html += "<cell style='flex-basis: {0}px'><edit contenteditable spellcheck='false'>{1}</edit><view>{2}</view></cell>".format(avg[j], rows[i][j], rows[i][j]);
          }
        }
        html += "</item>";
      }
      itOutput.html(html);

      // Update header and input widths
      for (i = 0; i < columns.length; ++i) {
        itHeader.xpath("/cell").eq(i).css("min-width", 0);
        itInput.xpath("/cell").eq(i).css("min-width", 0);
        itHeader.xpath("/cell").eq(i).css("flex-basis", avg[i]);
        itInput.xpath("/cell").eq(i).css("flex-basis", avg[i]);
        if (columns[i].startsWith("ID") || columns[i].startsWith("IMG")) {
          itHeader.xpath("/cell").eq(i).css("flex-grow", "0");
          itInput.xpath("/cell").eq(i).css("flex-grow", "0");
        }
        else { }
      }
    }

    // Get rows
    btGet.on("mousedown", function () {
      $.ajax({
        type: "POST", url: "/", data: { command: "get", sql: getSQL(table, columns, getInput(itInput.xpath("/cell"))) }, dataType: "json", success: function (result) {
          rows = [];
          for (i = 0; i < result.length; ++i) {
            rows[i] = result[i].toString().split(',');
          }
          getPage(1);
        }
      })
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Set number of rows and get first page
    cbRow.on("change", function () {
      row = cbRow.val();
      col = cbColumn.val();
      getPage(1);
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Set number of columns and get first page
    cbColumn.on("change", function () {
      row = cbRow.val();
      col = cbColumn.val();
      getPage(1);
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Insert n rows
    btInsert.on("mousedown", function () {
      number = prompt("How many rows do you want to insert:", "1");
      $.ajax({
        type: "POST", url: "/", data: { command: "insert", sql: insertSQL(table, columns, getInput(itInput.xpath("/cell"))), number: number }, dataType: "json", success: function (result) {
        }
      })
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Select rows
    btSelect.on("mousedown", function () {
      selectAllRows = !selectAllRows;
      if (selectAllRows == true) {
        itOutput.children().each(function (index) {
          $(this).addClass("selected");
        })
      }
      else {
        itOutput.children().each(function (index) {
          $(this).removeClass("selected");
        })
      }
    })

    function getSelectedRows() {
      result = [];
      itOutput.children().each(function (index) {
        if ($(this).hasClass("selected")) {
          result.push($(this).children().eq(0).text());
        }
        else { }
      })
      return result;
    }

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Delete selected rows
    btDelete.on("mousedown", function () {
      $.ajax({
        type: "POST", url: "/", data: { command: "delete", sql: deleteSQL(table, columns), id: getSelectedRows().join(";") }, dataType: "json", success: function (result) {
          btClear.trigger("mousedown");
          btGet.trigger("mousedown");
        }
      })
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////      
    // Set selected rows
    btSet.on("mousedown", function () {
      ids = getSelectedRows();
      values = getInput(itInput.xpath("/cell"));
      sqls = [];
      for (i = 0; i < ids.length; ++i) {
        sqls[i] = setSQL(table, columns, values) + ids[i];
      }
      $.ajax({
        type: "POST", url: "/", data: { command: "set", sql: sqls.join(";") }, dataType: "js", success: function (result) { }
      })
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Sort column
    itHeader.on("mousedown", "cell", function () {
      var order = $(this).data("order");
      order = order === "ASC" ? "DSC" : "ASC";
      $(this).data("order", order);
      index = $(this).index();
      itOutput.xpath("/item").sort(function (a, b) {
        a = $(a).find("data:eq({0})".format(index)).text();
        b = $(b).find("data:eq({0})".format(index)).text();
        if (types != null) {
          switch (types[index]) {
            case "text":
              return order === "ASC" ? a.localeCompare(b) : b.localeCompare(a);
            case "number":
              return order === "ASC" ? a - b : b - a;
            case "date":
              var dateFormat = function (dt) {
                [m, d, y] = dt.split('/');
                return [y, m - 1, d];
              }
              a = new Date(...dateFormat(a));
              b = new Date(...dateFormat(b));
              return order === "ASC" ? a.getTime() - b.getTime() : b.getTime() - a.getTime();
          }
        }
        else {
          return order === "ASC" ? a.toString().localeCompare(b.toString()) : b.toString().localeCompare(a.toString());
        }
      }).appendTo(itOutput);
    });

    // Update and select rows
    var oldtime2 = 0;
    itOutput.on("mousedown", "cell", function (event) {
      newtime = new Date().getTime();
      // Double click to edit/view all rows with current values
      if ((newtime - oldtime2) < 400) {
        itOutput.xpath("/item/cell[position() > 1]").each(function (index) {
          $(this).xpath("/edit").toggle();
          $(this).xpath("/view").toggle();
        })
        editState = !editState;

        // edit & hide => show
        if (editState == true && hideState == true) {
          hideState = !hideState;
          itHeader.xpath("/cell[position() > 3]").toggle();
          itInput.xpath("/cell[position() > 3]").toggle();
          itOutput.xpath("/item/cell[position() > 3]").toggle();
        }
        else // view mode
        { }
        // sqls = [];
        // tbody.children().each(function(index)
        // {
        //   values = getInput($(this));
        //   sqls[index] = setSQL(table, columns, values)  + values[0];
        // })
        // $.ajax({
        //   type: "POST", url: "/", data: { command: "set", sql: sqls.join(";")}, dataType: "json", success: function (result) 
        //   {
        //     btClear.trigger("mousedown");
        //     btGet.trigger("mousedown");
        //   }
        // })
      }
      // Single click to set current row to input row
      else {
        currentRow = $(this).parent();
        currentRow.toggleClass("selected");
        if (currentRow.hasClass("selected") == true) {
          currentRow.xpath("/cell/edit").each(function (index) {
            itInput.xpath("/cell/edit").eq(index).text($(this).text());
          })
        }
        else { }
      }
      oldtime2 = newtime;
    })

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Back to the first page
    btPageFirst.on("mousedown", function () {
      getPage(1);
    })

    // Back 1 page
    btPageBack1.on("mousedown", function () {
      getPage(pageIndex - 1);
    })

    // Back 10 pages
    btPageBack10.on("mousedown", function () {
      getPage(pageIndex - 10);
    })

    // Back 100 pages
    btPageBack100.on("mousedown", function () {
      getPage(pageIndex - 100);
    })

    // Get current page
    btPage.on("mousedown", function () {
      getPage(pageIndex);
    })

    // Next 1 page
    btPageNext1.on("mousedown", function () {
      getPage(pageIndex + 1);
    })

    // Next 10 pages
    btPageNext10.on("mousedown", function () {
      getPage(pageIndex + 10);
    })

    // Next 100 pages
    btPageNext100.on("mousedown", function () {
      getPage(pageIndex + 100);
    })

    // Next to the last page
    btPageLast.on("mousedown", function () {
      getPage(Math.ceil(rows.length / (row * col)));
    })
  })
</script>
</html>